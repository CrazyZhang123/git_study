解释 `get_activations_generic.py` 的功能和工作流程：
## 代码功能概述

从 text/label CSV 中提取语言模型的激活值（activations），用于后续的 steering vector 训练。这是 MAT-Steer 流程中的关键步骤。

## 核心工作流程

### 1. **数据加载** (第 37-43 行)
```python
def load_pairs(csv_path: Path):
```
- 读取包含 `text` 和 `label` 的 CSV
- 返回文本列表和标签列表
- 支持任何符合该格式的数据集（truthfulqa、bbq、safetybench 等）

### 2. **模型加载** (第 56-64 行)
- 通过 `HF_NAMES` 映射获取模型路径
- 加载 tokenizer 和模型（使用 float16，`device_map="auto"`）
- 模型用于前向传播以获取激活值

### 3. **设置激活值收集器** (第 70-81 行)
这是关键部分：

```python
collectors = []
pv_config = []
for layer in range(model.config.num_hidden_layers):
    collector = Collector(multiplier=0, head=-1)
    collectors.append(collector)
    pv_config.append({
        "component": f"model.layers[{layer}].self_attn.o_proj.input",
        "intervention": wrapper(collector),
    })
collected_model = pv.IntervenableModel(pv_config, model)
```

- 为每一层创建 `Collector`（`head=-1` 表示收集所有注意力头）
- 在 `self_attn.o_proj.input`（注意力输出投影的输入）处插入收集器
- 使用 `pyvene` 的 `IntervenableModel` 包装模型，以便在指定位置捕获激活值

### 4. **提取激活值** (第 83-91 行)
对每个 prompt：
```python
layer_wise, head_wise, _ = get_llama_activations_pyvene(collected_model, collectors, prompt, device)
last_token_layer = layer_wise[args.layer, -1, :].copy()
last_token_head = head_wise[args.layer, :].copy()
```

- `get_llama_activations_pyvene` 返回：
  - `layer_wise`: 形状 `(num_layers, seq_len, hidden_dim)`，每层的隐藏状态
  - `head_wise`: 形状 `(num_layers, num_heads * head_dim)`，每层所有注意力头的拼接
- 提取指定层（`args.layer`，默认 14）的最后一个 token 的激活值
- 这是模型对输入的最后表示，通常用于 steering

### 5. **保存结果** (第 93-105 行)
保存三种文件：
- `{model_name}_{dataset_name}_labels.npy/csv`: 标签
- `{model_name}_{dataset_name}_layer_wise.npy`: 层级别激活值 `(N, hidden_dim)`
- `{model_name}_{dataset_name}_head_wise.npy`: 头级别激活值 `(N, num_heads * head_dim)`

## 关键概念

### Collector 的作用
- `Collector` 在模型前向传播时捕获指定位置的激活值
- `__call__(b, s)` 中，`b` 是激活值张量，收集最后一个 token 的激活值
- `reset()` 在处理下一个样本前清空状态

### Pyvene 框架
- `pyvene` 用于在模型内部插入干预/收集点
- `IntervenableModel` 包装原始模型，允许在指定组件处插入函数
- 这里用于收集而非修改激活值

### 为什么提取最后一个 token？
- 最后一个 token 的激活值包含对完整输入的编码
- 用于训练 steering vector，以在推理时影响模型行为

## 使用示例

```bash
python get_activations_generic.py \
    --model_name llama3.1_8B \
    --dataset_name safetybench_train \
    --pairs_csv MAT-steer/get_activations/safetybench_train_pairs_seed42.csv \
    --layer 14 \
    --device 0
```

这会生成：
- `features/llama3.1_8B_safetybench_train_layer_wise.npy`
- `features/llama3.1_8B_safetybench_train_head_wise.npy`
- `features/llama3.1_8B_safetybench_train_labels.npy`

这些文件用于后续的 steering vector 训练。

需要我进一步解释某个部分吗？